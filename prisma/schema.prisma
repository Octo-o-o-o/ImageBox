generator client {
  provider = "prisma-client-js"
  // 打包到 Electron 时可能会同时构建 x64/arm64（或在某个架构上构建另一架构的安装包）
  // 若只生成 “native”，另一架构运行时会报 “Query engine for current platform not found”，导致 Next 首页 500 白屏。
  // 这里显式把 macOS 两个架构都打进包里（体积略增，但稳定性大幅提升）。
  binaryTargets = ["native", "darwin", "darwin-arm64"]
}

datasource db {
  provider = "sqlite"
  // Prisma 7+: URL 配置已移至 prisma.config.ts
}

model Provider {
  id          String   @id @default(uuid())
  name        String   // e.g. "OpenAI Official", "DeepSeek", "Localhost"
  type        String   // "GEMINI" | "OPENAI" | "LOCAL"
  baseUrl     String?  // Optional for official, required for custom/local
  apiKey      String?  // The key used for this provider (not needed for LOCAL)
  createdAt   DateTime @default(now())
  
  // Local model specific fields (only used when type = "LOCAL")
  localBackend    String?  // "SD_CPP" | "COMFYUI" | "DIFFSYNTH" | "CUSTOM"
  localModelPath  String?  // Path to model file (for auto-deploy reference)
  
  models      AIModel[]
}

model AIModel {
  id              String   @id @default(uuid())
  name            String   // Display Name e.g. "GPT-4o"
  modelIdentifier String   // API ID e.g. "gpt-4o"
  type            String   // "TEXT" | "IMAGE"

  // Parameter configuration for image generation models
  // JSON string containing parameter definitions and mappings
  // Example: {"supportedParams": ["aspectRatio", "imageSize"], "defaults": {"aspectRatio": "1:1"}}
  parameterConfig String?  @default("{}")

  provider        Provider? @relation(fields: [providerId], references: [id], onDelete: Cascade)
  providerId      String?

  createdAt       DateTime @default(now())

  templatesAsPrompter Template[] @relation("PromptGen")
}

model Template {
  id                String   @id @default(uuid())
  name              String
  icon              String?
  description       String?

  // Prompt Optimization Configuration
  promptTemplate    String   // The template for prompt optimization
  systemPrompt      String?  // System instructions for the optimization model
  promptGenerator   AIModel?   @relation("PromptGen", fields: [promptGeneratorId], references: [id])
  promptGeneratorId String?

  isEnabled         Boolean  @default(true) // Whether the template is enabled

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  images            Image[]
}

model Folder {
  id          String   @id @default(uuid())
  name        String
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())

  images      Image[]
}

model Image {
  id            String   @id @default(uuid())
  path          String   // Relative URL/path to the image file
  thumbnailPath String?  // Relative URL/path to the thumbnail (optional for backward compat)
  finalPrompt   String
  modelName     String
  params        String   // JSON of generation params
  isFavorite    Boolean  @default(false)

  template    Template? @relation(fields: [templateId], references: [id])
  templateId  String?

  folder      Folder?   @relation(fields: [folderId], references: [id])
  folderId    String?

  createdAt   DateTime @default(now())
}

model Setting {
  key   String @id
  value String
}

model RunLog {
  id              String   @id @default(uuid())
  requestTime     DateTime @default(now())
  completionTime  DateTime?
  duration        Int?             // In milliseconds
  type            String           // "PROMPT_GEN" | "IMAGE_GEN"
  status          String           // "SUCCESS" | "FAILURE" | "RUNNING"
  modelUsed       String?
  actualInput     String?
  output          String?          // Image path/URL or Text Output or Error Info
  parentTaskId    String?
  configParams    String?          // JSON of config
}

// 远程访问授权码
model AccessToken {
  id          String    @id @default(uuid())
  name        String                          // 用户自定义名称，方便识别
  description String?                         // 可选备注
  token       String    @unique               // 随机生成的授权码 (32字符)
  expiresAt   DateTime                        // 过期时间
  isRevoked   Boolean   @default(false)       // 是否已撤销
  createdAt   DateTime  @default(now())
  lastUsedAt  DateTime?                       // 最后使用时间
}
