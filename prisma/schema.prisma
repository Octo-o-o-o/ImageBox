generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  // Prisma 7+: URL 配置已移至 prisma.config.ts
}

model Provider {
  id          String   @id @default(uuid())
  name        String   // e.g. "OpenAI Official", "DeepSeek", "Localhost"
  type        String   // "GEMINI" | "OPENAI" | "LOCAL"
  baseUrl     String?  // Optional for official, required for custom/local
  apiKey      String?  // The key used for this provider (not needed for LOCAL)
  createdAt   DateTime @default(now())
  
  // Local model specific fields (only used when type = "LOCAL")
  localBackend    String?  // "SD_CPP" | "COMFYUI" | "DIFFSYNTH" | "CUSTOM"
  localModelPath  String?  // Path to model file (for auto-deploy reference)
  
  models      AIModel[]
}

model AIModel {
  id              String   @id @default(uuid())
  name            String   // Display Name e.g. "GPT-4o"
  modelIdentifier String   // API ID e.g. "gpt-4o"
  type            String   // "TEXT" | "IMAGE"

  // Parameter configuration for image generation models
  // JSON string containing parameter definitions and mappings
  // Example: {"supportedParams": ["aspectRatio", "imageSize"], "defaults": {"aspectRatio": "1:1"}}
  parameterConfig String?  @default("{}")

  provider        Provider? @relation(fields: [providerId], references: [id], onDelete: Cascade)
  providerId      String?

  createdAt       DateTime @default(now())

  templatesAsPrompter Template[] @relation("PromptGen")
  templatesAsImager   Template[] @relation("ImageGen")
}

model Template {
  id                String   @id @default(uuid())
  name              String
  icon              String?
  description       String?
  
  // Prompt Generation Configuration
  promptTemplate    String   // The prompt sent to the LLM (with {{slots}})
  systemPrompt      String?  // System instructions for the LLM
  promptGenerator   AIModel?   @relation("PromptGen", fields: [promptGeneratorId], references: [id])
  promptGeneratorId String?

  // Image Generation Configuration
  imageGenerator    AIModel?   @relation("ImageGen", fields: [imageGeneratorId], references: [id])
  imageGeneratorId  String?
  defaultParams     String   // JSON string of params (aspectRatio, etc.) for image gen

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  images            Image[]
}

model Folder {
  id          String   @id @default(uuid())
  name        String
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())

  images      Image[]
}

model Image {
  id            String   @id @default(uuid())
  path          String   // Relative URL/path to the image file
  thumbnailPath String?  // Relative URL/path to the thumbnail (optional for backward compat)
  finalPrompt   String
  modelName     String
  params        String   // JSON of generation params
  isFavorite    Boolean  @default(false)

  template    Template? @relation(fields: [templateId], references: [id])
  templateId  String?

  folder      Folder?   @relation(fields: [folderId], references: [id])
  folderId    String?

  createdAt   DateTime @default(now())
}

model Setting {
  key   String @id
  value String
}

model RunLog {
  id              String   @id @default(uuid())
  requestTime     DateTime @default(now())
  completionTime  DateTime?
  duration        Int?             // In milliseconds
  type            String           // "PROMPT_GEN" | "IMAGE_GEN"
  status          String           // "SUCCESS" | "FAILURE" | "RUNNING"
  modelUsed       String?
  actualInput     String?
  output          String?          // Image path/URL or Text Output or Error Info
  parentTaskId    String?
  configParams    String?          // JSON of config
}

// 远程访问授权码
model AccessToken {
  id          String    @id @default(uuid())
  name        String                          // 用户自定义名称，方便识别
  description String?                         // 可选备注
  token       String    @unique               // 随机生成的授权码 (32字符)
  expiresAt   DateTime                        // 过期时间
  isRevoked   Boolean   @default(false)       // 是否已撤销
  createdAt   DateTime  @default(now())
  lastUsedAt  DateTime?                       // 最后使用时间
}
