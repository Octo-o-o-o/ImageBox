# ImageBox 语言检测优化说明

## 📝 问题描述

原有应用在打包后，**未优先检测系统语言**，仅有以下逻辑：
1. 检查 `localStorage` 中用户之前选择的语言
2. 如果没有，使用硬编码的默认语言 `'en'`

这导致：
- 中文系统用户首次打开应用时显示英文
- 其他语言系统用户也无法看到对应的语言界面

---

## ✅ 修改方案

### 新的语言选择优先级

**优先级：用户保存的语言 > 系统语言 > 英文回退**

```
1. localStorage 中保存的语言（用户曾手动选择）
   ↓ 如果没有
2. 系统/浏览器语言（自动检测）
   ↓ 如果不支持
3. 英文（默认回退）
```

### 修改的文件

#### 1. `/components/LanguageProvider.tsx`
- ✅ 添加 `detectSystemLanguage()` 函数
  - 优先从 Electron API 获取系统语言（桌面应用）
  - 回退到浏览器 `navigator.language`（Web 版本）
  - 支持语言代码规范化（如 `zh-CN` → `zh`, `zh-TW` → `zh-TW`）
  
- ✅ 修改初始化逻辑
  - 如果 localStorage 没有保存的语言，调用 `detectSystemLanguage()`
  - 将检测到的系统语言保存到 localStorage

#### 2. `/electron-src/preload.ts`
- ✅ 添加 `getSystemLanguage()` API
  - 通过同步 IPC 从 Electron 主进程获取系统语言
  
- ✅ 更新 TypeScript 类型声明
  - 在 `Window.electronAPI` 接口中添加 `getSystemLanguage?: () => string`

#### 3. `/electron-src/main.ts`
- ✅ 添加 IPC 处理器 `i18n:getSystemLanguage`
  - 使用 `app.getLocale()` 获取系统语言
  - 通过同步 IPC 返回给渲染进程

---

## 🧪 测试建议

### 桌面应用测试

1. **清除本地存储**
   ```javascript
   // 在浏览器控制台执行
   localStorage.removeItem('imagebox-language');
   ```

2. **重启应用**
   - 应用应该自动检测系统语言并显示对应界面
   - 例如：中文系统 → 显示中文界面

3. **手动切换语言**
   - 在侧边栏切换语言
   - 重启应用后应保持手动选择的语言

4. **不支持的系统语言**
   - 例如系统语言为韩语（应用不支持）
   - 应回退到英文界面

### Web 版本测试

在浏览器中打开应用：
1. 清除 localStorage
2. 浏览器设置中修改首选语言
3. 刷新页面，检查是否显示对应语言

---

## 🌍 支持的语言列表

当前应用支持的语言（定义在 `lib/i18n/index.ts`）：

- `en` - English
- `zh` - 简体中文
- `zh-TW` - 繁體中文
- `ja` - 日本語
- `de` - Deutsch
- `fr` - Français
- `ru` - Русский
- `pt` - Português
- `es` - Español
- `it` - Italiano
- `ar` - العربية
- `no` - Norsk
- `sv` - Svenska

---

## 📌 语言代码规范化规则

```typescript
// 繁体中文特殊处理
"zh-TW", "zh-Hant", "zh-HK" → "zh-TW"

// 其他中文变体
"zh-CN", "zh-Hans", "zh-SG" → "zh"

// 其他语言
"en-US", "en-GB" → "en"
"fr-FR", "fr-CA" → "fr"
```

---

## 🔍 调试信息

如果语言检测有问题，可以在浏览器控制台查看：

```javascript
// 查看当前浏览器语言
console.log(navigator.language);

// 查看保存的语言
console.log(localStorage.getItem('imagebox-language'));

// Electron 桌面应用可以检查
console.log(window.electronAPI?.getSystemLanguage?.());
```

---

## 💡 注意事项

1. **首次启动**：首次打开应用时，会自动检测系统语言并保存
2. **用户选择优先**：用户手动选择语言后，会覆盖系统语言设置
3. **托盘菜单同步**：桌面应用的托盘菜单会自动跟随应用语言
4. **Web 版本兼容**：修改后的代码对 Web 版本完全兼容

---

## 📅 更新日志

**2025-12-24**
- 实现系统语言自动检测
- 优化语言选择优先级
- 添加语言代码规范化逻辑
- 同步 Electron 主进程与渲染进程语言状态
