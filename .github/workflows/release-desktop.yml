name: Release (Desktop installers)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag name (e.g. v0.1.0)"
        required: true
      target:
        description: "Target commit/branch for the tag (default: main)"
        required: false
        default: "main"

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Create GitHub Release (auto notes) [tag push]
        if: ${{ github.event_name == 'push' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          draft: false

      - name: Create GitHub Release (auto notes) [manual]
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag }}
          target_commitish: ${{ inputs.target }}
          generate_release_notes: true
          draft: false

  publish-windows-x64:
    needs: create-release
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Cache Electron downloads
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\electron\Cache
            ~\AppData\Local\electron-builder\Cache
          key: electron-cache-${{ runner.os }}-x64-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            electron-cache-${{ runner.os }}-x64-
            electron-cache-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Build & Publish (Windows x64)
        env:
          CI: "true"
        run: |
          npm run electron:compile
          npm run db:generate
          npm run db:template
          npm run build
          npm run electron:prepare
          npx --yes electron-builder --win --x64 --publish never

      - name: Upload assets to GitHub Release (Windows x64)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
          files: |
            dist-electron/*.exe
            dist-electron/*.yml
            dist-electron/*.blockmap

  publish-macos:
    needs: create-release
    name: Publish macOS ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15-intel
            arch: x64
          - runner: macos-latest
            arch: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Cache Electron downloads
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/electron
            ~/Library/Caches/electron-builder
          key: electron-cache-${{ runner.os }}-${{ matrix.arch }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            electron-cache-${{ runner.os }}-${{ matrix.arch }}-
            electron-cache-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Build & Publish (macOS ${{ matrix.arch }})
        env:
          CI: "true"
        run: |
          npm run electron:compile
          npm run db:generate
          npm run db:template
          npm run build
          npm run electron:prepare
          npx --yes electron-builder --mac --${{ matrix.arch }} --publish never

      - name: Upload assets to GitHub Release (macOS ${{ matrix.arch }})
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
          files: |
            dist-electron/*.dmg
            dist-electron/*.zip
            dist-electron/latest-mac*.yml
            dist-electron/*.blockmap

  publish-linux-x64:
    needs: create-release
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Cache Electron downloads
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: electron-cache-${{ runner.os }}-x64-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            electron-cache-${{ runner.os }}-x64-
            electron-cache-${{ runner.os }}-

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libarchive-tools \
            rpm \
            xvfb \
            libgtk-3-0 \
            libnss3 \
            libxss1 \
            libasound2t64 || sudo apt-get install -y libasound2

      - name: Install dependencies
        run: npm ci

      - name: Build & Publish (Linux x64)
        env:
          CI: "true"
        run: |
          npm run electron:compile
          npm run db:generate
          npm run db:template
          npm run build
          npm run electron:prepare
          npx --yes electron-builder --linux --x64 --publish never

      - name: Upload assets to GitHub Release (Linux x64)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
          files: |
            dist-electron/*.AppImage
            dist-electron/*.deb
            dist-electron/*.rpm
            dist-electron/*.yml
            dist-electron/*.blockmap


